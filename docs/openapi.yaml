openapi: 3.0.3
info:
  title: GPUBROKER API
  version: 2.0.0
  description: >
    GPUBROKER API contract for Auth, Provider, KPI, Booking preview, and WebSocket price updates.
    All endpoints served by Django 5 + Django Ninja at /api/v2/.

servers:
  - url: http://localhost:28080/api/v2
    description: Django backend

paths:
  /auth/register:
    post:
      summary: User registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Registration accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                  verification_required:
                    type: boolean
        '400':
          description: Invalid input

  /auth/login:
    post:
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                  expires_in:
                    type: integer
                  refresh_token:
                    type: string
        '401':
          description: Unauthorized

  /auth/refresh:
    post:
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: New access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
        '401':
          description: Invalid refresh token

  /providers:
    get:
      summary: List providers (paginated, filtered)
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            default: 20
        - in: query
          name: gpu
          schema:
            type: string
        - in: query
          name: region
          schema:
            type: string
        - in: query
          name: memory_min
          schema:
            type: integer
      responses:
        '200':
          description: List of providers
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProviderOffer'
                  warnings:
                    type: array
                    items:
                      type: string

  /config/integrations:
    get:
      summary: List provider integrations
      responses:
        '200':
          description: Integration statuses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IntegrationStatus'
    post:
      summary: Save provider credentials
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntegrationUpsert'
      responses:
        '200':
          description: Saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /kpi/overview:
    get:
      summary: KPI overview cards
      responses:
        '200':
          description: Current KPIs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KPIOverview'

  /bookings/preview:
    post:
      summary: Calculate booking cost estimate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [offer_id, hours]
              properties:
                offer_id:
                  type: string
                hours:
                  type: number
      responses:
        '200':
          description: Cost estimate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingEstimate'
        '400':
          description: Invalid request

  /health:
    get:
      summary: Service health
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

  /ws/price_updates:
    get:
      summary: WebSocket endpoint for live price updates
      description: Connect via WebSocket to receive `PriceUpdate` messages.
      responses:
        '101':
          description: Switching Protocols

components:
  schemas:
    ProviderOffer:
      type: object
      properties:
        id:
          type: string
        provider:
          type: string
        name:
          type: string
        gpu:
          type: string
        memory_gb:
          type: number
        price_per_hour:
          type: number
        currency:
          type: string
        region:
          type: string
        availability:
          type: string
        last_updated:
          type: string
          format: date-time

    IntegrationStatus:
      type: object
      properties:
        provider:
          type: string
        status:
          type: string
        message:
          type: string
        last_checked:
          type: string
          format: date-time

    IntegrationUpsert:
      type: object
      properties:
        provider:
          type: string
        api_key:
          type: string
        api_url:
          type: string

    KPIOverview:
      type: object
      properties:
        cost_per_token:
          type: number
        uptime_pct:
          type: number
        avg_latency_ms:
          type: number
        active_providers:
          type: integer

    BookingEstimate:
      type: object
      properties:
        estimate:
          type: number
        currency:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
        trace_id:
          type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
