# GPUBROKER - Local Production-Like Stack
# ===========================================
# Production-grade configuration for local development
# TOTAL MEMORY LIMIT: < 8GB
# PORT RANGE: 28000 - 28199
# LOGGING: JSON Driver, Max 50MB (Prevent Disk Failures)
# ===========================================

services:
  # ============================================
  # SECRET MANAGEMENT - HashiCorp Vault
  # Port: 28006
  # ============================================
  vault:
    image: hashicorp/vault:1.15
    container_name: gpubroker-vault
    hostname: vault
    restart: always
    ports:
      - "${PORT_VAULT:-28006}:8200"
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_API_ADDR: "http://0.0.0.0:8200"
      VAULT_LOG_LEVEL: "info"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
      - ./infrastructure/vault/config:/vault/config:ro
      - ./infrastructure/vault/scripts:/vault/scripts:ro
    command: server -config=/vault/config/vault.hcl
    healthcheck:
      test: [ "CMD", "vault", "status", "-address=http://127.0.0.1:8200" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 192M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # PostgreSQL Database
  # Port: 28002
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: gpubroker-postgres
    hostname: postgres
    restart: always
    ports:
      - "${PORT_POSTGRES:-28002}:5432"
    environment:
      POSTGRES_USER: gpubroker
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gpubroker_secure_local}
      POSTGRES_DB: gpubroker
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/backups
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./infrastructure/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    command: >
      postgres  -c shared_buffers=256MB  -c effective_cache_size=512MB  -c maintenance_work_mem=64MB  -c checkpoint_completion_target=0.9  -c wal_buffers=16MB  -c random_page_cost=1.1  -c log_statement=all  -c log_min_duration_statement=1000
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U gpubroker -d gpubroker" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Redis Cache & Sessions
  # Port: 28003
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: gpubroker-redis
    hostname: redis
    restart: always
    ports:
      - "${PORT_REDIS:-28003}:6379"
    command: >
      redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000 --loglevel notice --tcp-keepalive 300 --timeout 0
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Apache Kafka (KRaft - Official Image)
  # Port: 28007
  # ============================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: gpubroker-kafka
    hostname: kafka
    restart: always
    ports:
      - "${PORT_KAFKA:-28007}:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:${PORT_KAFKA:-28007}
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # ClickHouse Analytics Database
  # Ports: 28004 (HTTP), 28005 (Native)
  # ============================================
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: gpubroker-clickhouse
    hostname: clickhouse
    restart: always
    ports:
      - "${PORT_CLICKHOUSE_HTTP:-28004}:8123"
      - "${PORT_CLICKHOUSE_NATIVE:-28005}:9000"
    environment:
      CLICKHOUSE_DB: gpubroker_analytics
      CLICKHOUSE_USER: gpubroker
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse_secure_local}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8123/ping" ]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Django Backend (Main Application)
  # Port: 28001
  # ============================================
  django:
    build:
      context: ./backend/gpubroker
      dockerfile: Dockerfile
    container_name: gpubroker-django
    hostname: django
    restart: always
    ports:
      - "${PORT_DJANGO:-28001}:8000"
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.sandbox
      SECRET_KEY: ${DJANGO_SECRET_KEY:-django-local-prod-secure-key-change-in-real-prod}
      DEBUG: "False"
      ALLOWED_HOSTS: localhost,127.0.0.1,django,gpubroker.local
      DATABASE_URL: postgresql://gpubroker:${POSTGRES_PASSWORD:-gpubroker_secure_local}@postgres:5432/gpubroker
      REDIS_URL: redis://redis:6379/0
      KAFKA_BROKERS: kafka:9092
      CLICKHOUSE_URL: http://gpubroker:${CLICKHOUSE_PASSWORD:-clickhouse_secure_local}@clickhouse:8123/gpubroker_analytics
      VAULT_ADDR: http://vault:8200
      VAULT_ROLE_ID: ${VAULT_ROLE_ID:-}
      VAULT_SECRET_ID: ${VAULT_SECRET_ID:-}
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:${PORT_FRONTEND:-28000},http://localhost:${PORT_NGINX:-28080}
      SOMA_AGENT_BASE: ${SOMA_AGENT_BASE:-http://localhost:8080}
      PAYPAL_CLIENT_ID_SANDBOX: ${PAYPAL_CLIENT_ID_SANDBOX:-}
      PAYPAL_CLIENT_SECRET_SANDBOX: ${PAYPAL_CLIENT_SECRET_SANDBOX:-}
      JWT_PRIVATE_KEY: ${JWT_PRIVATE_KEY:-}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-}
      GPUBROKER_FORCE_COUNTRY: ${GPUBROKER_FORCE_COUNTRY:-EC}
      GPUBROKER_DEFAULT_REGION: ${GPUBROKER_DEFAULT_REGION:-US}
      GPUBROKER_DEPLOYMENT_REGION: ${GPUBROKER_DEPLOYMENT_REGION:-LATAM}
      S3_KNOWLEDGE_BUCKET: ${S3_KNOWLEDGE_BUCKET:-yachaq-lex-raw-0017472631}
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      vault:
        condition: service_started
    volumes:
      - ./backend/gpubroker:/app
      - ./backend/shared:/app/shared:ro
      - django_static:/app/staticfiles
      - django_media:/app/media
    command: >
      sh -c "
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        daphne -b 0.0.0.0 -p 8000 config.asgi:application
      "
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v2/admin/public/health" ]
      interval: 30s
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - gpubroker-network

  # ============================================
  # Next.js Frontend
  # Port: 28000
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gpubroker-frontend
    hostname: frontend
    restart: always
    ports:
      - "${PORT_FRONTEND:-28000}:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://localhost:${PORT_NGINX:-28080}/api/v2
      NEXT_PUBLIC_WS_URL: ws://localhost:${PORT_NGINX:-28080}/ws
      NEXT_PUBLIC_PROVIDER_API_URL: http://localhost:${PORT_NGINX:-28080}/api/v2/providers
      NEXT_PUBLIC_KPI_API_URL: http://localhost:${PORT_NGINX:-28080}/api/v2/kpi
      NEXT_PUBLIC_AI_API_URL: http://localhost:${PORT_NGINX:-28080}/api/v2/ai
    depends_on:
      - django
    command: bun run start
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
      interval: 30s
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Nginx Reverse Proxy
  # Ports: 28080, 28443
  # ============================================
  nginx:
    image: nginx:1.25-alpine
    container_name: gpubroker-nginx
    hostname: nginx
    restart: always
    ports:
      - "${PORT_NGINX:-28080}:80"
      - "${PORT_NGINX_SSL:-28443}:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - django_static:/var/www/static:ro
      - django_media:/var/www/media:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      django:
        condition: service_healthy
      frontend:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "nginx", "-t" ]
    deploy:
      resources:
        limits:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - gpubroker-network

  # ============================================
  # Prometheus Metrics
  # Port: 28008
  # ============================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: gpubroker-prometheus
    hostname: prometheus
    restart: always
    ports:
      - "${PORT_PROMETHEUS:-28008}:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.size=2GB"
    deploy:
      resources:
        limits:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Grafana Dashboards
  # Port: 28009
  # ============================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: gpubroker-grafana
    hostname: grafana
    restart: always
    ports:
      - "${PORT_GRAFANA:-28009}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin_local_secure}
      GF_SERVER_ROOT_URL: http://localhost:${PORT_GRAFANA:-28009}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./infrastructure/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # SpiceDB (Authorization)
  # Ports: 28012 (gRPC), 28013 (HTTP)
  # ============================================
  spicedb:
    image: authzed/spicedb:v1.29.0
    container_name: gpubroker-spicedb
    hostname: spicedb
    restart: always
    ports:
      - "${PORT_SPICEDB_GRPC:-28012}:50051"
      - "${PORT_SPICEDB_HTTP:-28013}:8443"
    environment:
      SPICEDB_GRPC_PRESHARED_KEY: "${SPICEDB_KEY:-somerandomkeyhere}"
      SPICEDB_DATASTORE_ENGINE: postgres
      SPICEDB_DATASTORE_CONN_URI: "postgres://gpubroker:${POSTGRES_PASSWORD:-gpubroker_secure_local}@postgres:5432/gpubroker?sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    command: serve
    deploy:
      resources:
        limits:
          memory: 384M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Apache Flink (Stream Processing)
  # Port: 28011 (UI)
  # ============================================
  flink-jobmanager:
    image: flink:1.18-scala_2.12
    container_name: gpubroker-flink-jobmanager
    hostname: flink-jobmanager
    restart: always
    ports:
      - "${PORT_FLINK_UI:-28011}:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  flink-taskmanager:
    image: flink:1.18-scala_2.12
    container_name: gpubroker-flink-taskmanager
    hostname: flink-taskmanager
    restart: always
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  # ============================================
  # Apache Airflow (Orchestration)
  # Port: 28010 (Web)
  # ============================================
  airflow-webserver:
    image: apache/airflow:2.8.0
    container_name: gpubroker-airflow-webserver
    hostname: airflow-webserver
    restart: always
    ports:
      - "${PORT_AIRFLOW_WEB:-28010}:8080"
    environment: &airflow-common-env
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://gpubroker:${POSTGRES_PASSWORD:-gpubroker_secure_local}@postgres:5432/gpubroker
      AIRFLOW__CORE__FERNET_KEY: "FB01D81C1014197F484C0F223D9078EC"
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW_ADMIN_USER: admin
      AIRFLOW_ADMIN_PASSWORD: admin
    volumes:
      - airflow_dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
      - airflow_plugins:/opt/airflow/plugins
    command: webserver
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

  airflow-scheduler:
    image: apache/airflow:2.8.0
    container_name: gpubroker-airflow-scheduler
    hostname: airflow-scheduler
    restart: always
    environment: *airflow-common-env
    volumes:
      - airflow_dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
      - airflow_plugins:/opt/airflow/plugins
    command: scheduler
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - gpubroker-network

# ============================================
# PERSISTENT VOLUMES
# ============================================
volumes:
  postgres_data:
    driver: local
    name: gpubroker_postgres_data
  postgres_backups:
    driver: local
    name: gpubroker_postgres_backups
  redis_data:
    driver: local
    name: gpubroker_redis_data
  clickhouse_data:
    driver: local
    name: gpubroker_clickhouse_data
  clickhouse_logs:
    driver: local
    name: gpubroker_clickhouse_logs
  kafka_data:
    driver: local
    name: gpubroker_kafka_data
  vault_data:
    driver: local
    name: gpubroker_vault_data
  vault_logs:
    driver: local
    name: gpubroker_vault_logs
  django_static:
    driver: local
    name: gpubroker_django_static
  django_media:
    driver: local
    name: gpubroker_django_media
  frontend_node_modules:
    driver: local
    name: gpubroker_frontend_node_modules
  frontend_next:
    driver: local
    name: gpubroker_frontend_next
  prometheus_data:
    driver: local
    name: gpubroker_prometheus_data
  grafana_data:
    driver: local
    name: gpubroker_grafana_data
  airflow_dags:
    driver: local
    name: gpubroker_airflow_dags
  airflow_logs:
    driver: local
    name: gpubroker_airflow_logs
  airflow_plugins:
    driver: local
    name: gpubroker_airflow_plugins
  nginx_logs:
    driver: local
    name: gpubroker_nginx_logs

# ============================================
# NETWORK CONFIGURATION
# ============================================
networks:
  gpubroker-network:
    driver: bridge
    name: gpubroker-net
