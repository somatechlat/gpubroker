{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - GPUBROKER Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="{% static 'gpubrokeradmin/css/admin.css' %}">
</head>

<body>
    <div class="admin-layout">
        <header class="admin-header">
            <a href="{% url 'gpubrokeradmin:admin_dashboard' %}" class="admin-logo" style="font-weight: 700; letter-spacing: -0.03em;">GPUBROKER</a>

            <!-- Environment Toggle (Sandbox/Live) -->
            <div class="env-toggle" id="envToggle">
                <button class="env-btn sandbox" onclick="setEnv('sandbox')">Sandbox</button>
                <button class="env-btn live active" onclick="setEnv('live')">Live</button>
            </div>

            <nav class="nav-tabs">
                <a href="{% url 'gpubrokeradmin:admin_dashboard' %}" class="nav-tab" style="text-decoration: none;">
                    <span class="material-symbols-rounded">dashboard</span>
                    <span class="nav-tab-label">Dashboard</span>
                </a>
                <a href="{% url 'gpubrokeradmin:admin_dashboard' %}?section=pods" class="nav-tab" style="text-decoration: none;">
                    <span class="material-symbols-rounded">dns</span>
                    <span class="nav-tab-label">Pods</span>
                </a>
                <a href="{% url 'gpubrokeradmin:admin_customers' %}" class="nav-tab" style="text-decoration: none;">
                    <span class="material-symbols-rounded">group</span>
                    <span class="nav-tab-label">Customers</span>
                </a>
                <a href="{% url 'gpubrokeradmin:admin_billing' %}" class="nav-tab active" style="text-decoration: none;">
                    <span class="material-symbols-rounded">payments</span>
                    <span class="nav-tab-label">Billing</span>
                </a>
                <a href="{% url 'gpubrokeradmin:admin_costs' %}" class="nav-tab" style="text-decoration: none;">
                    <span class="material-symbols-rounded">analytics</span>
                    <span class="nav-tab-label">Costs</span>
                </a>
            </nav>
            <div class="user-menu">
                <a href="{% url 'gpubrokeradmin:admin_dashboard' %}" class="btn btn-ghost" style="text-decoration: none;">
                    <span class="material-symbols-rounded">arrow_back</span>
                    Back
                </a>
            </div>
        </header>

        <main class="admin-main">
            <div id="txContainer" style="max-width: 1000px; margin: 0 auto;">
                <div style="text-align: center; padding: 4rem;">
                    <span class="material-symbols-rounded"
                        style="font-size: 3rem; color: var(--color-muted); animation: spin 1s linear infinite;">sync</span>
                    <p style="color: var(--color-muted); margin-top: 1rem;">Loading...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // SECURITY: Immediate auth check - redirect to login if not authenticated
        (function () {
            const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '{% url "gpubrokeradmin:admin_login" %}';
                return;
            }
        })();

        const API_BASE = '';

        // Environment state management
        let currentEnv = localStorage.getItem('admin_env') || 'live';

        function setEnv(env) {
            currentEnv = env;
            localStorage.setItem('admin_env', env);
            updateEnvUI();
            location.reload();
        }

        function updateEnvUI() {
            document.querySelectorAll('.env-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(currentEnv)) btn.classList.add('active');
            });
            document.body.classList.remove('env-sandbox', 'env-live');
            document.body.classList.add(`env-${currentEnv}`);
        }
        document.addEventListener('DOMContentLoaded', updateEnvUI);

        function getHeaders() {
            const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
            if (!token) { window.location.href = '{% url "gpubrokeradmin:admin_login" %}'; return {}; }
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'X-Environment': currentEnv };
        }

        const urlParams = new URLSearchParams(window.location.search);
        const txId = urlParams.get('tx');

        async function loadTransaction() {
            if (!txId) {
                try {
                    const resp = await fetch(`${API_BASE}/api/v2/admin/billing`, { headers: getHeaders() });
                    if (!resp.ok) throw new Error('Failed');
                    const data = await resp.json();
                    renderAllTransactions(data);
                } catch (e) {
                    document.getElementById('txContainer').innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--color-error);">error</span>
                            <h2 style="margin: 1rem 0 0.5rem;">Error Loading</h2>
                            <a href="{% url 'gpubrokeradmin:admin_login' %}" class="btn btn-primary">Login</a>
                        </div>
                    `;
                }
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/api/v2/admin/transaction/${encodeURIComponent(txId)}`, { headers: getHeaders() });
                if (!resp.ok) throw new Error('Transaction not found');
                const data = await resp.json();
                renderTransaction(data);
            } catch (e) {
                document.getElementById('txContainer').innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--color-error);">receipt_long</span>
                        <h2 style="margin: 1rem 0 0.5rem;">Transaction Not Found</h2>
                        <p style="color: var(--color-muted);">${txId}</p>
                        <a href="{% url 'gpubrokeradmin:admin_dashboard' %}" class="btn btn-primary" style="margin-top: 1rem;">Back</a>
                    </div>
                `;
            }
        }

        function renderAllTransactions(data) {
            const transactions = data.transactions || [];
            const total = data.total_revenue || 0;

            document.getElementById('txContainer').innerHTML = `
                <!-- Header Card - Compact -->
                <div class="card" style="background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border-color: #bbf7d0; padding: 12px 16px; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #22c55e; color: white; display: flex; align-items: center; justify-content: center;">
                            <span class="material-symbols-rounded" style="font-size: 20px;">payments</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #15803d;">$${total} USD</div>
                            <div style="font-size: 0.8rem; color: #15803d;">Total Revenue</div>
                        </div>
                        <span class="status-badge running">${transactions.length} TX</span>
                    </div>
                </div>
                
                <!-- Transactions List - Compact -->
                <div class="card" style="padding: 12px;">
                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--color-muted); text-transform: uppercase; margin-bottom: 8px;">All Transactions</div>
                    ${transactions.length > 0 ? transactions.map(p => `
                        <div class="master-item" onclick="window.location='{% url 'gpubrokeradmin:admin_billing' %}?tx=${p.transaction_id || ''}'">
                            <div class="master-item-avatar" style="background: #dcfce7; color: #22c55e;">
                                <span class="material-symbols-rounded" style="font-size: 18px;">check</span>
                            </div>
                            <div class="master-item-info">
                                <div class="master-item-title">${p.email || 'Unknown'}</div>
                                <div class="master-item-subtitle">${p.date || ''} • ${p.plan || 'pro'}</div>
                            </div>
                            <span style="font-weight: 600; color: var(--color-success);">$${p.amount || '?'}</span>
                        </div>
                    `).join('') : '<p style="padding: 1rem; text-align: center; color: var(--color-muted);">No transactions</p>'}
                </div>
            `;
        }

        function renderTransaction(data) {
            document.getElementById('txContainer').innerHTML = `
                <!-- Header Card - Compact -->
                <div class="card" style="background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border-color: #bbf7d0; padding: 12px 16px; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #22c55e; color: white; display: flex; align-items: center; justify-content: center;">
                            <span class="material-symbols-rounded" style="font-size: 20px;">check</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #15803d;">$${data.amount || 0} USD</div>
                            <div style="font-size: 0.8rem; color: #15803d;">Payment Completed</div>
                        </div>
                        <span class="status-badge running">PAID</span>
                    </div>
                </div>
                
                <!-- 3-Column Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <!-- Col 1: Transaction Details -->
                    <div class="card" style="padding: 12px;">
                        <div style="font-size: 0.7rem; font-weight: 600; color: var(--color-muted); text-transform: uppercase; margin-bottom: 8px;">Transaction</div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">ID</span>
                            <span style="font-weight: 500; font-family: var(--font-mono); font-size: 0.75rem;">${(data.transaction_id || txId).slice(0, 12)}...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Method</span>
                            <span style="font-weight: 500;">${data.method || 'PayPal'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Date</span>
                            <span style="font-weight: 500;">${data.date || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <!-- Col 2: Customer Details -->
                    <div class="card" style="padding: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.7rem; font-weight: 600; color: var(--color-muted); text-transform: uppercase;">Customer</span>
                            <span class="cross-ref" style="font-size: 0.75rem;" onclick="window.location='{% url 'gpubrokeradmin:admin_customers' %}?email=${encodeURIComponent(data.email || '')}'">View →</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Email</span>
                            <span style="font-weight: 500;">${data.email || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Name</span>
                            <span style="font-weight: 500;">${data.name || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Plan</span>
                            <span style="font-weight: 500;">${(data.plan || 'pro').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <!-- Col 3: Pod Details -->
                    <div class="card" style="padding: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.7rem; font-weight: 600; color: var(--color-muted); text-transform: uppercase;">Pod</span>
                            ${data.pod_id ? `<span class="cross-ref" style="font-size: 0.75rem;" onclick="window.location='{% url 'gpubrokeradmin:admin_dashboard' %}'">View →</span>` : ''}
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Pod ID</span>
                            <span style="font-weight: 500; font-family: var(--font-mono);">${data.pod_id || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Region</span>
                            <span style="font-weight: 500;">us-east-1</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem;">
                            <span style="color: var(--color-muted);">Status</span>
                            <span class="status-badge running" style="font-size: 10px;">ACTIVE</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline - Compact -->
                <div class="card" style="padding: 12px; margin-bottom: 12px;">
                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--color-muted); text-transform: uppercase; margin-bottom: 8px;">History</div>
                    <div style="padding-left: 16px; border-left: 2px solid var(--color-border);">
                        <div style="position: relative; padding-bottom: 10px;">
                            <div style="position: absolute; left: -20px; width: 8px; height: 8px; border-radius: 50%; background: var(--color-success);"></div>
                            <div style="font-size: 0.7rem; color: var(--color-muted);">${data.created_at || 'N/A'}</div>
                            <div style="font-size: 0.85rem; font-weight: 500;">Payment completed via PayPal</div>
                        </div>
                        <div style="position: relative; padding-bottom: 10px;">
                            <div style="position: absolute; left: -20px; width: 8px; height: 8px; border-radius: 50%; background: var(--color-success);"></div>
                            <div style="font-size: 0.7rem; color: var(--color-muted);">${data.created_at || 'N/A'}</div>
                            <div style="font-size: 0.85rem; font-weight: 500;">Pod provisioned on AWS ECS</div>
                        </div>
                        <div style="position: relative;">
                            <div style="position: absolute; left: -20px; width: 8px; height: 8px; border-radius: 50%; background: var(--color-success);"></div>
                            <div style="font-size: 0.7rem; color: var(--color-muted);">${data.created_at || 'N/A'}</div>
                            <div style="font-size: 0.85rem; font-weight: 500;">Subscription activated</div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions - Compact -->
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="window.print()">
                        <span class="material-symbols-rounded">print</span> Print
                    </button>
                    <button class="btn btn-secondary" id="btnResend">
                        <span class="material-symbols-rounded">mail</span> Resend
                    </button>
                    ${data.pod_id ? `<a href="{% url 'gpubrokeradmin:admin_dashboard' %}?pod=${encodeURIComponent(data.pod_id)}" class="btn btn-secondary">
                        <span class="material-symbols-rounded">dns</span> View Pod
                    </a>` : ''}
                    <a href="{% url 'gpubrokeradmin:admin_customers' %}?email=${encodeURIComponent(data.email || '')}" class="btn btn-primary">
                        <span class="material-symbols-rounded">person</span> View Customer
                    </a>
                </div>
            `;

            // Add event listener for Resend button
            const resendEmail = data.email;
            const resendTxId = txId;
            const resendAmount = data.amount || 0;

            document.getElementById('btnResend').onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Sending...';

                try {
                    const resp = await fetch(API_BASE + '/api/v2/admin/resend-receipt', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            email: resendEmail,
                            transaction_id: resendTxId,
                            amount: resendAmount
                        })
                    });

                    if (resp.ok) {
                        btn.innerHTML = '<span class="material-symbols-rounded">check</span> Sent!';
                        btn.style.background = '#dcfce7';
                        btn.style.color = '#22c55e';
                    } else {
                        throw new Error('Failed');
                    }
                } catch (e) {
                    // Fallback to mailto
                    window.open('mailto:' + resendEmail + '?subject=GPUBROKER Receipt - $' + resendAmount + ' USD&body=Thank you for your payment of $' + resendAmount + ' USD.');
                    btn.innerHTML = '<span class="material-symbols-rounded">mail</span> Resend';
                }

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-rounded">mail</span> Resend';
                    btn.style.background = '';
                    btn.style.color = '';
                }, 3000);
            };
        }

        loadTransaction();
    </script>

    <style>
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>
